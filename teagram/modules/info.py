#                            â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#                            â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•”â•â•šâ•â•â•â•â–ˆâ–ˆâ•‘
#                            â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•”â•â•
#                            â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–‘â–‘â•šâ–ˆâ–ˆâ•”â•â–‘â–‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘
#                            â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#                            â•šâ•â•â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â–‘â–‘â•šâ•â•â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â•šâ•â•â•â•â•â•â•
#                                            https://t.me/itzlayz
#                           
#                                    ğŸ”’ Licensed under the GNU AGPLv3
#                                 https://www.gnu.org/licenses/agpl-3.0.html

import telethon
import time

from .terminal import bash_exec
from .. import __version__, loader, utils, validators
from ..types import Config, ConfigValue
from ..bot import BotManager

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, InlineQueryResultPhoto

from telethon.tl.custom import Message
from datetime import timedelta

@loader.module(name="info", author='teagram')
class InfoMod(loader.Module):
    """Ğ£Ğ·Ğ½Ğ°Ğ¹Ñ‚Ğµ Ñ‡Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ ÑĞ·ĞµÑ€Ğ±Ğ¾Ñ‚, Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ°ÑˆĞµĞ¼ ğŸµteagram"""
    strings = {'name': 'info'}

    def __init__(self):
        self.boot_time = time.time()
        self.config = Config(
            ConfigValue(
                option='customText',
                default='',
                value=self.db.get('info', 'customText', ''),
                validator=validators.String(),
                doc="ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°: cpu, ram, tele, owner, uptime, version, platform"
            ),
            ConfigValue(
                option='customImage',
                doc='',
                default='',
                value=self.db.get('info', 'customImage', ''),
                validator=validators.String()
            )
        )
        self.bot: BotManager = self.bot

    async def info_inline_handler(self, inline):
        platform = utils.get_platform()
        uptime = timedelta(seconds=round(time.time() - utils._init_time))
        
        last = utils.git_hash()
        now = str(await bash_exec('git rev-parse HEAD')).strip()
        version = f'v{__version__}' + (' '+self.strings('update') if last != now else "")

        me = (await self.client.get_me()).username

        default = f"""
<b>ğŸ’ {self.strings('owner')}</b>:  <code>{me}</code>
<b>ğŸ§ {self.strings('version')}</b>:  <code>{version}</code> (<a href="https://github.com/itzlayz/teagram-tl/commit/{last}">{last[:7]}</a>)

<b>ğŸ§  CPU</b>:  <code>{utils.get_cpu()}%</code>
<b>ğŸ“€ RAM</b>:  <code>{utils.get_ram()}MB</code>

<b>âŒš {self.strings('uptime')}</b>:  <code>{uptime}</code>
<b>ğŸ“± {self.strings('version')} telethon: <code>{telethon.__version__}</code></b>

<b>{platform}</b>
"""
        davatar = 'https://github.com/itzlayz/teagram-tl/blob/main/assets/bot_avatar.png?raw=true'

        custom = self.config.get('customText')
        avatar = self.config.get('customImage')

        if custom:
            custom = custom.format(
                owner=me,
                cpu=utils.get_cpu(),
                ram=utils.get_ram(),
                uptime=uptime,
                version=version,
                platform=platform,
                tele=telethon.__version__
            )

        await inline.answer(
            [
                InlineQueryResultPhoto(
                    id=utils.random_id(),
                    title='teagram',
                    thumb_url=avatar or davatar,
                    photo_url=avatar or davatar,
                    caption=default or custom,
                    reply_markup=InlineKeyboardMarkup().row(
                        InlineKeyboardButton('â“ Teagram', url='https://t.me/UBteagram'),
                        InlineKeyboardButton('ğŸ¤– Github', url='https://github.com/itzlayz/teagram-tl')
                    )
                )
            ]
        )
    
    async def info_cmd(self, message: Message):
        """Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ°ÑˆĞµĞ¼ ğŸµteagram."""
        await self.bot.invoke_unit('info', message)